<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>GenAI KB ‚Äî Search</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg: #0a0a0a; --surface: #141414; --surface-hover: #1a1a1a;
      --border: #2a2a2a; --text: #e8e8e8; --text-secondary: #999;
      --text-dim: #555; --accent: #ff4d00; --accent-dim: rgba(255,77,0,0.15);
    }
    body {
      font-family: 'Inter', -apple-system, sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100vh; font-size: 14px; line-height: 1.6;
    }
    .container { max-width: 900px; margin: 0 auto; padding: 32px 24px; }

    /* Header */
    .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 32px; border-bottom: 2px solid var(--accent); padding-bottom: 16px; }
    .logo { font-family: 'JetBrains Mono', monospace; font-size: 20px; font-weight: 500; color: var(--accent); letter-spacing: 1px; text-decoration: none; }
    .nav { display: flex; gap: 16px; }
    .nav a { color: var(--text-secondary); text-decoration: none; font-size: 13px; }
    .nav a:hover { color: var(--accent); }

    /* Search */
    .search-box { position: relative; margin-bottom: 24px; }
    .search-input {
      width: 100%; padding: 16px 20px; padding-right: 50px;
      background: var(--surface); border: 1px solid var(--border); border-radius: 12px;
      color: var(--text); font-size: 16px; font-family: inherit; outline: none;
      transition: border-color 0.2s;
    }
    .search-input:focus { border-color: var(--accent); }
    .search-input::placeholder { color: var(--text-dim); }
    .search-count {
      position: absolute; right: 16px; top: 50%; transform: translateY(-50%);
      color: var(--text-dim); font-size: 12px; font-family: 'JetBrains Mono', monospace;
    }

    /* Filters */
    .filters { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 24px; }
    .chip {
      padding: 6px 14px; border-radius: 20px; font-size: 12px; cursor: pointer;
      background: var(--surface); border: 1px solid var(--border); color: var(--text-secondary);
      transition: all 0.2s; user-select: none;
    }
    .chip:hover { border-color: var(--accent); color: var(--text); }
    .chip.active { background: var(--accent-dim); border-color: var(--accent); color: var(--accent); }
    .chip .count { opacity: 0.5; margin-left: 4px; }

    /* Results */
    .results { display: flex; flex-direction: column; gap: 12px; }
    .card {
      background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
      padding: 16px; transition: border-color 0.2s; cursor: pointer;
    }
    .card:hover { border-color: var(--accent); }
    .card-title { font-weight: 600; color: #fff; margin-bottom: 6px; font-size: 15px; }
    .card-title a { color: inherit; text-decoration: none; }
    .card-title a:hover { color: var(--accent); }
    .card-meta {
      display: flex; gap: 12px; font-size: 11px; color: var(--text-dim);
      font-family: 'JetBrains Mono', monospace; margin-bottom: 8px;
    }
    .card-meta .cat { color: var(--accent); }
    .card-desc { color: var(--text-secondary); font-size: 13px; line-height: 1.5; }
    .card-tags { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
    .tag {
      font-size: 10px; padding: 2px 8px; border-radius: 4px;
      background: var(--accent-dim); color: var(--accent);
      font-family: 'JetBrains Mono', monospace;
    }
    .score-bar {
      width: 40px; height: 3px; background: var(--border); border-radius: 2px;
      overflow: hidden; display: inline-block; vertical-align: middle; margin-left: 6px;
    }
    .score-fill { height: 100%; background: var(--accent); border-radius: 2px; }

    /* Stats */
    .stats {
      text-align: center; padding: 40px; color: var(--text-dim); font-size: 13px;
    }
    .stats .big { font-size: 48px; font-weight: 600; color: var(--accent); font-family: 'JetBrains Mono', monospace; }

    /* Empty state */
    .empty { text-align: center; padding: 60px 20px; color: var(--text-dim); }
    .empty .icon { font-size: 48px; margin-bottom: 16px; }

    /* Loading */
    .loading { text-align: center; padding: 40px; color: var(--text-dim); }
    @keyframes pulse { 0%,100% { opacity:0.3; } 50% { opacity:1; } }
    .loading .dot { animation: pulse 1.5s infinite; display: inline-block; }
    .loading .dot:nth-child(2) { animation-delay: 0.3s; }
    .loading .dot:nth-child(3) { animation-delay: 0.6s; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <a href="index.html" class="logo">FR491L3 √ó KB Search</a>
      <div class="nav">
        <a href="index.html">Board</a>
        <a href="genai-kb.html">Raw KB</a>
        <a href="genai-kb-editorial.html">Editorial</a>
      </div>
    </div>

    <div class="search-box">
      <input type="text" class="search-input" id="searchInput"
        placeholder="Search the knowledge base... (e.g. 'karpathy on agents' or 'image generation tools')"
        autofocus>
      <span class="search-count" id="searchCount"></span>
    </div>

    <div class="filters" id="filters"></div>

    <div id="results" class="results"></div>

    <div class="stats" id="stats">
      <div class="big" id="totalCount">‚Äî</div>
      <div>entries in the GenAI Knowledge Base</div>
      <div style="margin-top:8px; font-size:11px;">Type to search ‚Ä¢ Click categories to filter ‚Ä¢ Results ranked by relevance</div>
    </div>
  </div>

  <script>
    let fuse, allEntries = [], activeCategory = null;

    async function init() {
      try {
        const res = await fetch('genai-kb.json');
        allEntries = await res.json();
        if (!Array.isArray(allEntries)) allEntries = allEntries.entries || allEntries.items || [];

        document.getElementById('totalCount').textContent = allEntries.length;

        // Build category chips
        const cats = {};
        allEntries.forEach(e => {
          const c = e.category || 'Other';
          cats[c] = (cats[c] || 0) + 1;
        });
        const sorted = Object.entries(cats).sort((a,b) => b[1] - a[1]);
        const filtersEl = document.getElementById('filters');
        filtersEl.innerHTML = sorted.map(([cat, count]) =>
          `<span class="chip" data-cat="${cat}">${cat}<span class="count">${count}</span></span>`
        ).join('');

        filtersEl.querySelectorAll('.chip').forEach(chip => {
          chip.addEventListener('click', () => {
            const cat = chip.dataset.cat;
            if (activeCategory === cat) {
              activeCategory = null;
              chip.classList.remove('active');
            } else {
              filtersEl.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
              activeCategory = cat;
              chip.classList.add('active');
            }
            doSearch();
          });
        });

        // Init Fuse
        fuse = new Fuse(allEntries, {
          keys: [
            { name: 'title', weight: 3 },
            { name: 'summary', weight: 2 },
            { name: 'content', weight: 1 },
            { name: 'source', weight: 1.5 },
            { name: 'tags', weight: 1 },
            { name: 'category', weight: 1 }
          ],
          threshold: 0.4,
          includeScore: true,
          minMatchCharLength: 2,
          ignoreLocation: true
        });

        // Listen for input
        document.getElementById('searchInput').addEventListener('input', debounce(doSearch, 150));

      } catch (err) {
        document.getElementById('results').innerHTML =
          `<div class="empty"><div class="icon">‚ö†Ô∏è</div>Failed to load KB: ${err.message}</div>`;
      }
    }

    function doSearch() {
      const query = document.getElementById('searchInput').value.trim();
      const resultsEl = document.getElementById('results');
      const statsEl = document.getElementById('stats');
      const countEl = document.getElementById('searchCount');

      if (!query && !activeCategory) {
        resultsEl.innerHTML = '';
        statsEl.style.display = '';
        countEl.textContent = '';
        return;
      }

      statsEl.style.display = 'none';
      let results;

      if (query) {
        results = fuse.search(query, { limit: 50 }).map(r => ({
          ...r.item,
          _score: 1 - r.score
        }));
      } else {
        results = allEntries.map(e => ({ ...e, _score: 1 }));
      }

      // Category filter
      if (activeCategory) {
        results = results.filter(r => r.category === activeCategory);
      }

      // Sort by score then date
      results.sort((a, b) => {
        if (Math.abs(a._score - b._score) > 0.1) return b._score - a._score;
        return new Date(b.date || 0) - new Date(a.date || 0);
      });

      countEl.textContent = results.length + ' results';

      if (results.length === 0) {
        resultsEl.innerHTML = `<div class="empty"><div class="icon">üîç</div>No results for "${query || activeCategory}"</div>`;
        return;
      }

      resultsEl.innerHTML = results.slice(0, 30).map(r => {
        const date = r.date ? new Date(r.date).toLocaleDateString('en-AU', { day:'numeric', month:'short', year:'numeric' }) : '';
        const score = Math.round((r._score || 0) * 100);
        const tags = (r.tags || []).slice(0, 4);
        const desc = (r.summary || r.content || '').slice(0, 200);
        const url = r.url || '#';

        return `<div class="card" onclick="window.open('${url}','_blank')">
          <div class="card-title"><a href="${url}" target="_blank" onclick="event.stopPropagation()">${esc(r.title || 'Untitled')}</a></div>
          <div class="card-meta">
            <span class="cat">${esc(r.category || 'Other')}</span>
            <span>${esc(r.source || '')}</span>
            <span>${date}</span>
            ${query ? `<span>${score}%<span class="score-bar"><span class="score-fill" style="width:${score}%"></span></span></span>` : ''}
          </div>
          ${desc ? `<div class="card-desc">${esc(desc)}${desc.length >= 200 ? '‚Ä¶' : ''}</div>` : ''}
          ${tags.length ? `<div class="card-tags">${tags.map(t => `<span class="tag">${esc(t)}</span>`).join('')}</div>` : ''}
        </div>`;
      }).join('');
    }

    function esc(s) {
      if (!s) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function debounce(fn, ms) {
      let t; return (...a) => { clearTimeout(t); t = setTimeout(() => fn(...a), ms); };
    }

    init();
  </script>
</body>
</html>
